<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Rubble v3.4 (Fixed Markers)</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* --- THEME VARIABLES --- */
        :root {
            --bg-app: #f3f4f6;
            --bg-container: #ffffff;
            --text-main: #1f2937;
            --text-muted: #6b7280;
            --teal-primary: #0d9488;
            --teal-dark: #0f766e;
            --card-bg: #ffffff;
            --border-color: #e5e7eb;
            --shadow: 0 4px 6px rgba(0,0,0,0.05);
            --accent-glass: #22d3ee; /* Cyan for Glass */
        }

        .dark-mode {
            --bg-app: #111827;
            --bg-container: #1f2937;
            --text-main: #f9fafb;
            --text-muted: #9ca3af;
            --card-bg: #374151;
            --border-color: #4b5563;
            --shadow: 0 4px 6px rgba(0,0,0,0.3);
        }

        /* --- CORE LAYOUT --- */
        body { font-family: 'Segoe UI', sans-serif; background-color: var(--bg-app); display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; color: var(--text-main); transition: 0.3s; }
        .app-container { width: 100%; max-width: 400px; background-color: var(--bg-container); border-radius: 25px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); overflow: hidden; height: 880px; display: flex; flex-direction: column; position: relative; }

        .header { background: linear-gradient(to right, var(--teal-primary), var(--teal-dark)); padding: 15px 20px; color: white; display: flex; justify-content: space-between; align-items: center; z-index: 10; }
        .notification-btn { background: none; border: none; color: white; font-size: 20px; cursor: pointer; position: relative; }
        .badge { position: absolute; top: 0; right: 0; width: 10px; height: 10px; background-color: #ef4444; border-radius: 50%; border: 2px solid var(--teal-dark); display: none; }

        .content { flex: 1; overflow-y: auto; background-color: var(--bg-app); }
        .page { display: none; animation: fadeIn 0.3s; padding-bottom: 20px; }
        .page.active { display: block; }

        /* --- NOTIFICATION PANEL --- */
        .notification-panel { position: absolute; top: 60px; right: 10px; width: 300px; background: var(--bg-container); border-radius: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); z-index: 100; display: none; padding: 10px; max-height: 400px; overflow-y: auto; }
        .notif-item { padding: 10px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; font-size: 13px; transition: 0.2s; }
        .notif-item:hover { background: rgba(0,0,0,0.02); }
        .notif-actions button { border: none; background: none; cursor: pointer; font-size: 16px; margin-left: 5px; }

        /* --- IMAGE INSPECTOR --- */
        #imageModal { display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 2000; flex-direction: column; justify-content: center; align-items: center; }
        .zoom-controls { position: absolute; bottom: 50px; display: flex; gap: 20px; }
        .zoom-btn { background: white; border: none; padding: 12px 20px; border-radius: 50px; font-weight: bold; cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.3); }

        /* --- HOME SECTION --- */
        .stats-card { background: linear-gradient(to bottom right, #eff6ff, #f0fdfa); padding: 20px; border-bottom: 1px solid var(--border-color); color: #1f2937; }
        .grid-stats { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-top: 15px; }
        .stat-box { background: white; padding: 10px 5px; border-radius: 8px; text-align: center; font-size: 11px; box-shadow: var(--shadow); transition: all 0.3s ease; }
        .stat-box.updating { transform: scale(1.05); background-color: #ecfdf5; }

        .map-wrapper { height: 250px; margin: 15px; border-radius: 15px; overflow: hidden; box-shadow: var(--shadow); position: relative; }
        #map { height: 100%; width: 100%; }

        /* SEARCH & LIST */
        .search-container { padding: 0 15px; margin-top: 10px; }
        .search-input { width: 100%; padding: 10px 15px; border-radius: 50px; border: 1px solid var(--border-color); background: var(--card-bg); color: var(--text-main); box-sizing: border-box; outline: none; box-shadow: var(--shadow); }
        
        .stock-item { display: flex; align-items: center; gap: 12px; }
        
        /* UPDATED CSS FOR CIRCULAR LIST IMAGES */
        .stock-img { 
            width: 60px; 
            height: 60px; 
            border-radius: 50%; /* Makes it circular */
            object-fit: cover; 
            border: 3px solid var(--bg-container); /* White border */
            box-shadow: 0 2px 5px rgba(0,0,0,0.2); /* Shadow for pop */
        }

        .important-section { padding: 0 15px; margin-top: 20px; }
        .important-card { background: var(--card-bg); padding: 12px; border-radius: 10px; border-left: 4px solid #f59e0b; margin-bottom: 10px; box-shadow: var(--shadow); font-size: 13px; }

        /* --- SETTINGS & GAMIFICATION --- */
        .profile-box { background: var(--teal-primary); color: white; margin: 15px; padding: 20px; border-radius: 15px; text-align: center; cursor: pointer; transition: 0.2s; position: relative; overflow: hidden; }
        .xp-bar-bg { width: 100%; height: 6px; background: rgba(255,255,255,0.3); border-radius: 10px; margin-top: 10px; overflow: hidden; }
        .xp-bar-fill { height: 100%; width: 70%; background: #fbbf24; border-radius: 10px; }

        .settings-item { background: var(--card-bg); margin: 5px 15px; padding: 15px; border-radius: 12px; display: flex; justify-content: space-between; align-items: center; border: 1px solid var(--border-color); cursor: pointer; }
        
        /* --- UI COMPONENTS --- */
        .toast { position: absolute; top: 70px; left: 50%; transform: translateX(-50%); background: #065f46; color: white; padding: 10px 25px; border-radius: 50px; font-size: 14px; z-index: 1000; display: none; box-shadow: 0 4px 12px rgba(0,0,0,0.2); animation: slideDown 0.3s; }
        .list-item { background: var(--card-bg); margin: 15px; padding: 15px; border-radius: 12px; border: 1px solid var(--border-color); box-shadow: var(--shadow); }
        
        .btn-action { background: var(--teal-primary); color: white; border: none; padding: 12px; border-radius: 8px; font-weight: bold; cursor: pointer; width: 100%; transition: 0.2s; }
        .btn-secondary { flex: 1; background: var(--bg-app); color: var(--text-main); border: 1px solid var(--border-color); padding: 10px; border-radius: 8px; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 5px; }

        .bottom-nav { background: var(--bg-container); border-top: 1px solid var(--border-color); padding: 12px 0; display: flex; justify-content: space-around; }
        .nav-btn { background: none; border: none; display: flex; flex-direction: column; align-items: center; color: var(--text-muted); cursor: pointer; font-size: 10px; transition: 0.2s; }
        .nav-btn.active { color: var(--teal-primary); font-weight: bold; }

        .chart-container { position: relative; height: 250px; width: 95%; margin: 10px auto; }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideDown { from { top: 40px; opacity: 0; } to { top: 70px; opacity: 1; } }
    </style>
</head>
<body id="appBody">

    <div class="app-container">
        <div id="successToast" class="toast">‚úÖ Action Successful!</div>

        <div id="imageModal">
            <span style="position:absolute; top:20px; right:20px; color:white; font-size:30px; cursor:pointer;" onclick="closeInspector()">‚úï</span>
            <div style="overflow:hidden; width:90%; height:70%; display:flex; justify-content:center; align-items:center;">
                <img id="inspectImage" src="" style="transition: transform 0.2s; max-width:100%; max-height:100%;">
            </div>
            <div class="zoom-controls">
                <button class="zoom-btn" onclick="adjustZoom(0.3)">‚ûï Zoom In</button>
                <button class="zoom-btn" onclick="adjustZoom(-0.3)">‚ûñ Zoom Out</button>
            </div>
        </div>

        <div class="header">
            <div style="font-weight:bold; font-size:18px;">‚ôªÔ∏è Smart Rubble <span style="font-size:10px; opacity:0.8;">v3.4</span></div>
            <button class="notification-btn" onclick="toggleNotifications()">
                üîî <span class="badge" id="notifBadge"></span>
            </button>
        </div>

        <div class="notification-panel" id="notifPanel">
            <div style="display:flex; justify-content:space-between; margin-bottom:10px; border-bottom: 1px solid var(--border-color);">
                <strong>Message Center</strong><span onclick="toggleNotifications()" style="cursor:pointer">‚úï</span>
            </div>
            <div id="notifList"></div>
        </div>

        <div class="content">
            <div id="home" class="page active">
                <div class="stats-card">
                    <p style="margin:0;">Live Updates: You saved <span id="liveCO2" style="font-weight:bold; color:#0f766e">2.40</span> tons of CO‚ÇÇ</p>
                    <div class="grid-stats">
                        <div class="stat-box" id="statReportsbox"><b id="liveReports">128</b><br>Reports</div>
                        <div class="stat-box" id="statTonsbox"><b id="liveTons">1,420</b><br>Tons</div>
                        <div class="stat-box"><b id="liveReused">14</b><br>Reused</div>
                        <div class="stat-box" style="color:green;"><b id="livePercent">+32.0%</b><br>Saved</div>
                    </div>
                </div>

                <div class="map-wrapper">
                    <div id="map"></div>
                </div>

                <h3 style="margin: 20px 0 10px 15px;">Live Stocks & Locations</h3>
                <div class="search-container">
                    <input type="text" id="stockSearch" class="search-input" placeholder="üîç Search materials (Glass, Concrete...)" onkeyup="filterStockList()">
                </div>

                <div id="stockList" style="padding: 0 15px; padding-bottom: 20px;"></div>

                <div class="important-section">
                    <h4 style="margin: 0 0 10px 0; color: var(--teal-primary);">üìå Pinned Alerts</h4>
                    <div id="importantList"></div>
                </div>
            </div>

            <div id="reports" class="page">
                <h2 style="margin:15px;">New AI Report</h2>
                <div style="padding: 0 15px;">
                    <div id="previewContainer" style="height:140px; background:#e5e7eb; border-radius:12px; display:flex; align-items:center; justify-content:center; margin-bottom:10px; color:gray;">
                        No Image Selected
                    </div>
                    
                    <div style="display:flex; gap:10px; margin-bottom:10px;">
                        <input type="file" id="imageInput" accept="image/*" onchange="previewImage(event)" style="display:none;">
                        <button class="btn-secondary" onclick="document.getElementById('imageInput').click()">üìÅ File</button>
                        <button class="btn-secondary" onclick="document.getElementById('imageInput').click()">üì∑ Camera</button>
                    </div>

                    <div style="display:flex; gap:5px; margin-bottom:10px;">
                        <input type="text" id="locInput" placeholder="Location Name" style="flex:1; padding:12px; border-radius:8px; border:1px solid var(--border-color);">
                        <button class="btn-secondary" style="flex:0 0 50px;" onclick="geoLocate()">üìç</button>
                    </div>

                    <input type="number" id="tonInput" placeholder="Approx. Tons" style="width:100%; padding:12px; margin-bottom:15px; border-radius:8px; border:1px solid var(--border-color); box-sizing:border-box;">
                    <button class="btn-action" onclick="submitReport()">Submit Report</button>
                </div>
                <h3 style="margin:20px 0 0 15px;">Active Reports</h3>
                <div id="reportsList"></div>
            </div>

            <div id="stats" class="page">
                <h2 style="margin:20px;">Eco Analytics</h2>
                <div class="list-item">
                    <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                        <span>Material Breakdown</span>
                        <span style="font-weight:bold; color:var(--teal-primary)">Live Data</span>
                    </div>
                    <div class="chart-container">
                        <canvas id="ecoChart"></canvas>
                    </div>
                </div>
                <div class="list-item">
                    <strong>Monthly Top Materials</strong>
                    <div style="margin-top:10px;">
                        <div style="margin-bottom:5px; display:flex; justify-content:space-between; font-size:12px;"><span>Concrete</span><span>55%</span></div>
                        <div style="height:6px; background:#e5e7eb; border-radius:4px;"><div style="width:55%; height:100%; background:var(--teal-primary); border-radius:4px;"></div></div>
                    </div>
                    <div style="margin-top:10px;">
                        <div style="margin-bottom:5px; display:flex; justify-content:space-between; font-size:12px;"><span>Steel / Metal</span><span>25%</span></div>
                        <div style="height:6px; background:#e5e7eb; border-radius:4px;"><div style="width:25%; height:100%; background:#f59e0b; border-radius:4px;"></div></div>
                    </div>
                    <div style="margin-top:10px;">
                        <div style="margin-bottom:5px; display:flex; justify-content:space-between; font-size:12px;"><span>Glass</span><span>15%</span></div>
                        <div style="height:6px; background:#e5e7eb; border-radius:4px;"><div style="width:15%; height:100%; background:var(--accent-glass); border-radius:4px;"></div></div>
                    </div>
                </div>
            </div>

            <div id="recycleBin" class="page">
                <div style="display:flex; align-items:center; padding:15px;">
                    <button class="btn-secondary" style="flex:0; margin-right:10px;" onclick="switchPage('settings')">‚¨Ö</button>
                    <h2 style="margin:0;">Recycle Bin</h2>
                </div>
                <p style="padding:0 15px; color:gray; font-size:13px;">Recover deleted messages here.</p>
                <div id="binList"></div>
            </div>

            <div id="settings" class="page">
                <h2>Settings</h2>
                <div id="profileSection"></div>
                
                <div class="settings-item">
                    <span>Dark Appearance</span>
                    <input type="checkbox" id="darkToggle" onchange="toggleDark()">
                </div>
                <div class="settings-item" onclick="openRecycleBin()">
                    <span>üóëÔ∏è Recycle Bin</span><span>‚Ä∫</span>
                </div>
                <div class="settings-item">
                    <span>App Version</span><span style="color:var(--text-muted)">v3.4</span>
                </div>
                <div id="logoutSection"></div>
            </div>

            <div id="auth" class="page">
                <h2 id="authTitle" style="text-align:center; margin-top:40px;">Sign In</h2>
                <div class="auth-form">
                    <input type="email" placeholder="Email Address">
                    <input type="password" placeholder="Password">
                    <button class="btn-action" onclick="handleAuth()">Continue</button>
                    <button class="btn-action" style="background:gray;" onclick="switchPage('settings')">Cancel</button>
                </div>
            </div>
        </div>

        <div class="bottom-nav">
            <button class="nav-btn active" onclick="switchPage('home')">üè†<br>Home</button>
            <button class="nav-btn" onclick="switchPage('reports')">üìÑ<br>Reports</button>
            <button class="nav-btn" onclick="switchPage('stats')">üìà<br>Stats</button>
            <button class="nav-btn" onclick="switchPage('settings')">‚öôÔ∏è<br>Settings</button>
        </div>
    </div>

    <script>
        // --- DATA STATE ---
        let isLoggedIn = false;
        let currentImageData = "";
        let currentZoom = 1;
        let stats = { co2: 2.40, reports: 128, tons: 1420, reused: 14 };
        
        // --- LOCATIONS DATA (12 Items) ---
        let rubbleLocations = [
            { id: 1, name: "Concrete Rubble", lat: 25.2854, lng: 51.5310, tons: 45, distance: "2.3 km", score: 82, image: 'concrete.jpeg' },
            { id: 2, name: "Mixed Debris", lat: 25.2900, lng: 51.5400, tons: 32, distance: "1.8 km", score: 75, image: 'debris.jpeg' },
            { id: 3, name: "Metal Scrap", lat: 25.2800, lng: 51.5250, tons: 28, distance: "3.1 km", score: 90, image: 'metal.jpeg' },
            { id: 4, name: "Glass Shards", lat: 25.2880, lng: 51.5380, tons: 12, distance: "1.2 km", score: 95, image: 'glass.jpeg' },
            { id: 5, name: "Brick Rubble", lat: 25.2820, lng: 51.5350, tons: 38, distance: "2.7 km", score: 88, image: 'brick.jpeg' },
            { id: 6, name: "Asphalt Chunks", lat: 25.2950, lng: 51.5200, tons: 60, distance: "4.5 km", score: 70, image: 'asphalt.jpeg' },
            { id: 7, name: "Timber Waste", lat: 25.2750, lng: 51.5450, tons: 15, distance: "3.8 km", score: 85, image: 'timber.jpeg' },
            { id: 8, name: "Ceramic Tiles", lat: 25.2860, lng: 51.5150, tons: 8, distance: "2.1 km", score: 92, image: 'tiles.jpeg' },

        ];

        let notifications = [
            { id: 1, title: "Welcome!", text: "Start reporting rubble to earn points.", page: "home", important: false }
        ];
        
        let deletedNotifications = [];

        // --- CHART JS INIT ---
        let ecoChartInstance = null;
        function initChart() {
            const ctx = document.getElementById('ecoChart').getContext('2d');
            if (ecoChartInstance) ecoChartInstance.destroy();
            
            ecoChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Concrete', 'Metal', 'Glass'],
                    datasets: [{
                        label: 'Recycled Volume (Tons)',
                        data: [450, 200, 120],
                        backgroundColor: ['#0d9488', '#f59e0b', '#22d3ee'],
                        borderRadius: 5
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: { y: { beginAtZero: true } }
                }
            });
        }

        // --- CANVAS ICON GENERATOR (FIXES WHITE RING ISSUE) ---
        function createCircularIcon(imageUrl, callback) {
            const img = new Image();
            img.crossOrigin = "Anonymous"; // Attempt to handle CORS
            img.src = imageUrl;
            
            img.onload = function() {
                const canvas = document.createElement('canvas');
                const size = 60; // Icon size (px)
                canvas.width = size;
                canvas.height = size;
                const ctx = canvas.getContext('2d');

                // 1. Create circular clipping path
                ctx.beginPath();
                ctx.arc(size/2, size/2, size/2, 0, Math.PI * 2);
                ctx.closePath();
                ctx.clip();

                // 2. Draw the image
                ctx.drawImage(img, 0, 0, size, size);

                // 3. Draw the white border
                ctx.beginPath();
                ctx.arc(size/2, size/2, size/2 - 2, 0, Math.PI * 2); 
                ctx.lineWidth = 4;
                ctx.strokeStyle = '#ffffff';
                ctx.stroke();

                // 4. Return the data URL
                callback(canvas.toDataURL());
            };

            // Fallback if image fails to load
            img.onerror = function() {
                const canvas = document.createElement('canvas');
                canvas.width = 60; canvas.height = 60;
                const ctx = canvas.getContext('2d');
                ctx.beginPath(); ctx.arc(30, 30, 30, 0, Math.PI*2);
                ctx.fillStyle = '#999'; ctx.fill();
                ctx.strokeStyle = 'white'; ctx.lineWidth = 4; ctx.stroke();
                callback(canvas.toDataURL());
            }
        }

        // --- GOOGLE MAPS INIT ---
        let map;
        function initMap() {
            const center = { lat: 25.2854, lng: 51.5310 };
            map = new google.maps.Map(document.getElementById("map"), {
                zoom: 12, center: center, disableDefaultUI: true,
                styles: [ { "featureType": "poi", "stylers": [ { "visibility": "off" } ] } ]
            });

            rubbleLocations.forEach(loc => {
                // Asynchronously generate the icon via Canvas
                createCircularIcon(loc.image, (iconData) => {
                    const marker = new google.maps.Marker({
                        position: { lat: loc.lat, lng: loc.lng },
                        map: map, 
                        title: loc.name,
                        icon: {
                            url: iconData, 
                            scaledSize: new google.maps.Size(50, 50),
                            origin: new google.maps.Point(0, 0),
                            anchor: new google.maps.Point(25, 25)
                        }
                    });

                    const infoWindow = new google.maps.InfoWindow({
                        content: `<div style="color:black; text-align:center;"><img src="${loc.image}" style="width:40px; height:40px; border-radius:50%; object-fit:cover; margin-bottom:5px;"><br><b>${loc.name}</b><br>${loc.tons} tons available</div>`
                    });
                    marker.addListener("click", () => { infoWindow.open(map, marker); });
                });
            });
        }

        // --- NOTIFICATION & RECYCLE BIN LOGIC ---
        function renderNotifications() {
            const list = document.getElementById('notifList');
            const impList = document.getElementById('importantList');
            const badge = document.getElementById('notifBadge');
            list.innerHTML = ""; impList.innerHTML = "";

            if (notifications.length === 0) {
                list.innerHTML = '<div style="text-align:center; padding:20px; color:gray;">No new notifications ‚úÖ</div>';
                badge.style.display = 'none';
            } else { badge.style.display = 'block'; }

            notifications.forEach(n => {
                const item = document.createElement('div');
                item.className = 'notif-item';
                item.innerHTML = `
                    <div onclick="handleNotifClick('${n.page}')" style="flex:1; cursor:pointer;">
                        <b>${n.title}</b><br><span style="color:var(--text-muted)">${n.text}</span>
                    </div>
                    <div class="notif-actions">
                        <button onclick="toggleImp(${n.id})">${n.important ? '‚≠ê' : '‚òÜ'}</button>
                        <button onclick="deleteNotif(${n.id})">üóëÔ∏è</button>
                    </div>`;
                list.appendChild(item);
                if (n.important) {
                    const card = document.createElement('div'); card.className = 'important-card';
                    card.innerHTML = `<b>${n.title}</b>: ${n.text}`; impList.appendChild(card);
                }
            });
        }

        function handleNotifClick(pageId) { switchPage(pageId); toggleNotifications(); }

        function deleteNotif(id) {
            const item = notifications.find(x => x.id === id);
            if (item) {
                deletedNotifications.push(item);
                notifications = notifications.filter(x => x.id !== id);
                renderNotifications();
                showToast("Moved to Recycle Bin");
            }
        }

        function openRecycleBin() { switchPage('recycleBin'); renderBin(); }

        function renderBin() {
            const list = document.getElementById('binList');
            list.innerHTML = "";
            if(deletedNotifications.length === 0) {
                list.innerHTML = '<div style="text-align:center; padding:20px;">Bin is empty üóëÔ∏è</div>';
                return;
            }
            deletedNotifications.forEach(n => {
                const item = document.createElement('div');
                item.className = 'list-item';
                item.innerHTML = `
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <div><b>${n.title}</b><br>${n.text}</div>
                        <button class="btn-action" style="width:auto; padding:5px 10px; font-size:12px;" onclick="restoreNotif(${n.id})">Restore ‚Ü©Ô∏è</button>
                    </div>`;
                list.appendChild(item);
            });
        }

        function restoreNotif(id) {
            const item = deletedNotifications.find(x => x.id === id);
            if(item) {
                notifications.unshift(item);
                deletedNotifications = deletedNotifications.filter(x => x.id !== id);
                renderBin();
                showToast("Message Restored");
                renderNotifications();
            }
        }

        function toggleNotifications() {
            const p = document.getElementById('notifPanel');
            p.style.display = (p.style.display === 'block') ? 'none' : 'block';
        }
        function toggleImp(id) { const n = notifications.find(x => x.id === id); n.important = !n.important; renderNotifications(); }

        // --- REPORTING LOGIC ---
        function submitReport() {
            const loc = document.getElementById('locInput').value;
            const tons = document.getElementById('tonInput').value;
            if (!loc || !tons) return alert("Please fill in all details");

            const list = document.getElementById('reportsList');
            const item = document.createElement('div'); item.className = 'list-item';
            let imgTag = currentImageData ? `<img src="${currentImageData}" onclick="openInspector('${currentImageData}')" style="width:100%; border-radius:8px; margin-bottom:10px; cursor:zoom-in;">` : '';
            item.innerHTML = `${imgTag}<strong>${loc}</strong><p style="color:gray; font-size:13px;">${tons} Tons ‚Ä¢ Status: Pending Review</p>`;
            list.prepend(item);

            const newNotif = { id: Date.now(), title: "Report Submitted", text: `Details for ${loc}`, page: "reports", important: false };
            notifications.unshift(newNotif);
            renderNotifications();
            showToast("Report Posted!");
            
            document.getElementById('locInput').value = ""; document.getElementById('tonInput').value = "";
            document.getElementById('previewContainer').innerHTML = "No Image Selected";
            currentImageData = "";
        }

        function previewImage(e) {
            const reader = new FileReader();
            reader.onload = () => {
                document.getElementById('previewContainer').innerHTML = `<img src="${reader.result}" style="width:100%; height:100%; object-fit:cover;">`;
                currentImageData = reader.result;
            };
            if(e.target.files[0]) reader.readAsDataURL(e.target.files[0]);
        }
        
        function geoLocate() {
            document.getElementById('locInput').value = "Locating...";
            setTimeout(() => { document.getElementById('locInput').value = "25.285, 51.531"; }, 1000);
        }

        // --- LIVE STOCK RENDER (WITH PHOTOS) ---
        function renderStockList(filterText = "") {
            const list = document.getElementById('stockList');
            list.innerHTML = '';
            
            const filtered = rubbleLocations.filter(loc => 
                loc.name.toLowerCase().includes(filterText.toLowerCase())
            );

            if(filtered.length === 0) {
                list.innerHTML = '<div style="text-align:center; padding:20px; color:gray;">No materials found.</div>';
                return;
            }

            filtered.forEach(loc => {
                const item = document.createElement('div');
                item.className = 'list-item stock-item';
                
                item.innerHTML = `
                    <img src="${loc.image}" class="stock-img" onclick="openInspector('${loc.image}')" alt="${loc.name}">
                    <div style="flex:1;">
                        <div style="display:flex; justify-content:space-between; align-items:center;">
                           <strong>${loc.name}</strong>
                           <span style="font-size:10px; background:rgba(13,148,136,0.1); color:var(--teal-primary); padding:2px 6px; border-radius:4px;">LIVE</span>
                        </div>
                        <p style="margin:2px 0; color:var(--text-muted); font-size:13px;">${loc.distance} ‚Ä¢ ${loc.tons} tons</p>
                        <p style="margin:0; color:var(--teal-primary); font-size:12px; font-weight:600;">Reuse Score: ${loc.score}%</p>
                    </div>
                `;
                list.appendChild(item);
            });
        }

        function filterStockList() { renderStockList(document.getElementById('stockSearch').value); }
        function updateLiveStats() {
            const box = document.getElementById('statTonsbox');
            box.classList.add('updating');
            setTimeout(() => box.classList.remove('updating'), 500);
        }
        setInterval(updateLiveStats, 5000);

        // --- NAVIGATION ---
        function switchPage(pId) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(pId).classList.add('active');
            document.querySelectorAll('.nav-btn').forEach(b => {
                b.classList.remove('active');
                if (b.getAttribute('onclick').includes(pId)) b.classList.add('active');
            });
            if(pId === 'stats') setTimeout(initChart, 100); 
        }

        function showToast(msg) {
            const t = document.getElementById('successToast');
            t.innerText = msg; t.style.display = 'block';
            setTimeout(() => t.style.display = 'none', 2500);
        }
        function toggleDark() { document.body.classList.toggle('dark-mode'); }
        function renderProfile() {
            const container = document.getElementById('profileSection');
            const logoutArea = document.getElementById('logoutSection');
            if (isLoggedIn) {
                container.innerHTML = `<div class="profile-box"><h3>John Doe</h3><div class="xp-bar-bg"><div class="xp-bar-fill"></div></div><p style="font-size:10px; margin-top:5px;">Level 5 Recycler</p></div>`;
                logoutArea.innerHTML = `<div style="text-align:center; color:#ef4444; margin-top:20px; font-weight:bold; cursor:pointer;" onclick="logout()">Log Out</div>`;
            } else {
                container.innerHTML = `<div class="profile-box" onclick="switchPage('auth')"><h3>Sign In</h3><p>Manage account</p></div>`;
                logoutArea.innerHTML = "";
            }
        }
        function handleAuth() { isLoggedIn = true; renderProfile(); switchPage('settings'); }
        function logout() { isLoggedIn = false; renderProfile(); showToast("Logged out"); }
        function openInspector(src) { document.getElementById('inspectImage').src = src; document.getElementById('imageModal').style.display = 'flex'; }
        function closeInspector() { document.getElementById('imageModal').style.display = 'none'; }
        function adjustZoom(amt) { currentZoom += amt; if(currentZoom < 0.5) currentZoom = 0.5; document.getElementById('inspectImage').style.transform = `scale(${currentZoom})`; }

        // Init
        renderProfile(); renderNotifications(); renderStockList();
    </script>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAOVYRIgupAurZup5y1PRh8Ismb1A3lLao&callback=initMap" async defer></script>
</body>
</html>
